<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monaco Code Editor</title>
    <style>
        /* YOUR CSS STYLES - These remain the same */
        body {
            font-family: monospace;
            display: flex;
            flex-direction: column;
            height: 100vh; /* Full viewport height */
            margin: 0;
            padding: 20px;
            background-color: #282c34; /* Dark background */
            color: #abb2bf; /* Light text color */
        }

        h1 {
            color: #61afef; /* A nice blue for headings */
            margin-bottom: 15px;
        }

        #editor-container {
            flex-grow: 1; /* Allows it to take available space */
            display: flex;
            flex-direction: column;
            border: 1px solid #61afef;
            border-radius: 5px;
            overflow: hidden; /* Important for containing Monaco */
        }

        #editor {
            flex-grow: 1;
            height: 100%;
        }

        #terminal-output {
            background-color: #000000;
            color: #ffffff;
            padding: 10px;
            height: 200px; /* Fixed height for terminal */
            overflow-y: auto; /* Scroll if content overflows */
            border-top: 1px solid #61afef;
            font-size: 0.9em;
            white-space: pre-wrap; /* Preserve formatting like newlines */
            box-sizing: border-box;
        }

        #terminal-input-container {
            display: flex;
            background-color: #000000;
            border-top: 1px solid #61afef;
        }

        #terminal-input {
            flex-grow: 1;
            background-color: #000000;
            color: #ffffff;
            border: none;
            outline: none;
            padding: 10px;
            font-family: monospace;
            font-size: 0.9em;
        }

        button {
            margin-top: 10px;
            padding: 10px 15px;
            background-color: #61afef;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.2s ease;
        }

        button:hover {
            background-color: #528abd;
        }

        button:disabled {
            background-color: #888;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <h1>Simple Python Editor</h1>
    <div id="editor-container">
        <div id="editor"></div>
        <div id="terminal-output"></div>
        <div id="terminal-input-container">
            <input type="text" id="terminal-input" placeholder="Type input here..." disabled>
            <button id="send-input-btn" disabled>Send Input</button>
        </div>
    </div>
    <button id="run-btn">Run Code</button>

    <script src="https://unpkg.com/monaco-editor@0.48.0/min/vs/loader.js"></script>
    <script>
        let editor; // Declare Monaco editor instance globally accessible

        require.config({ paths: { 'vs': 'https://unpkg.com/monaco-editor@0.48.0/min/vs' }});

        require(['vs/editor/editor.main'], function() {
            // --- START OF DIAGNOSTIC CODE ---
            const editorDiv = document.getElementById('editor');
            console.log("Attempting to find editor div for Monaco. Element found:", editorDiv); // Diagnostic log

            if (!editorDiv) {
                console.error("CRITICAL ERROR: The <div> with id='editor' was NOT FOUND in the HTML document when Monaco tried to initialize. Monaco cannot be created. The page will likely be blank or partially rendered.");
                // You could add an alert here if you want to be very obvious, but console error is usually enough for debugging.
                // alert("Error: Monaco editor container 'editor' not found! Check HTML IDs and script placement.");
                return; // Stop further JavaScript execution if the essential div is missing
            }
            // --- END OF DIAGNOSTIC CODE ---

            // If editorDiv was found, then proceed to create the editor:
            editor = monaco.editor.create(editorDiv, { // Use the editorDiv variable here
                value: `print("Hello, interactive world!")
name = input("What's your name? ")
print(f"Nice to meet you, {name}!")
age = input("How old are you? ")
print(f"So you are {age} years old.")`,
                language: 'python',
                theme: 'vs-dark',
                minimap: { enabled: false },
                automaticLayout: true
            });

            // Only initialize the rest of the application if the editor was successfully created
            if (editor) {
                initializeApplication();
            } else {
                console.error("Monaco editor creation failed even though the div was found. Further investigation needed.");
            }
        });

        function initializeApplication() {
            const terminalOutput = document.getElementById('terminal-output');
            const terminalInput = document.getElementById('terminal-input');
            const sendInputBtn = document.getElementById('send-input-btn');
            const runBtn = document.getElementById('run-btn');

            let ws = null; // WebSocket variable managed within this scope

            function appendOutput(message, type = 'info') {
                const messageElement = document.createElement('div');
                messageElement.textContent = message;
                if (type === 'error') {
                    messageElement.style.color = 'red';
                } else if (type === 'status') {
                    messageElement.style.color = 'lightgray';
                }
                terminalOutput.appendChild(messageElement);
                terminalOutput.scrollTop = terminalOutput.scrollHeight;
            }

            function clearOutput() {
                terminalOutput.innerHTML = '';
            }

            function enableInput(enable) {
                terminalInput.disabled = !enable;
                sendInputBtn.disabled = !enable;
                if (enable) {
                    terminalInput.focus();
                }
            }

            // Ensure runBtn exists before adding event listener
            if (!runBtn) {
                console.error("Error: Run button with id 'run-btn' not found.");
                return;
            }
            if (!editor) { // Also ensure editor is available
                console.error("Error: Monaco editor instance is not available for run button listener.");
                return;
            }


            runBtn.addEventListener('click', () => {
                clearOutput();
                enableInput(false);
                runBtn.disabled = true;
                appendOutput("Processing...", "status");

                if (ws) {
                    console.log("Closing previous WebSocket connection if open.");
                    ws.onopen = null;
                    ws.onmessage = null;
                    ws.onerror = null;
                    ws.onclose = null;
                    if (ws.readyState === WebSocket.OPEN || ws.readyState === WebSocket.CONNECTING) {
                        ws.close();
                    }
                }

                // ** THIS IS THE WebSocket URL WE ARE AIMING FOR ULTIMATELY **
                // ** Ensure your Nginx on EC2 is correctly proxying wss://myonlinepython.in to your backend **
                appendOutput("Attempting to connect to backend wss://myonlinepython.in ...", "status");
                ws = new WebSocket('wss://myonlinepython.in');


                ws.onopen = () => {
                    console.log('Frontend WebSocket connection opened to wss://myonlinepython.in');
                    appendOutput("Connection established. Sending code...", "status");
                    const code = editor.getValue();
                    if (ws.readyState === WebSocket.OPEN) {
                        ws.send(JSON.stringify({ type: 'code', value: code, language: 'python' }));
                    }
                };

                ws.onmessage = event => {
                    console.log('Frontend received message:', event.data);
                    try {
                        const data = JSON.parse(event.data);
                        if (data.type === 'output') {
                            appendOutput(data.value, 'output');
                            const trimmedValue = data.value.trim().toLowerCase();
                            if (trimmedValue.includes('?') || trimmedValue.endsWith(':') || trimmedValue === '') {
                                if (runBtn.disabled) {
                                    enableInput(true);
                                }
                            }
                        } else if (data.type === 'error') {
                            appendOutput(`ERROR: ${data.value}`, 'error');
                            if (ws && ws.readyState === WebSocket.OPEN) ws.close();
                            runBtn.disabled = false;
                            enableInput(false);
                        } else if (data.type === 'status') {
                            appendOutput(`STATUS: ${data.value}`, 'status');
                        } else if (data.type === 'end') {
                            appendOutput("--- Program Finished ---", 'status');
                            if (ws && ws.readyState === WebSocket.OPEN) ws.close();
                            runBtn.disabled = false;
                            enableInput(false);
                        }
                    } catch (e) {
                        console.error("Error parsing message from backend or handling it:", e);
                        appendOutput("Received unparseable message from backend: " + event.data, "error");
                    }
                };

                ws.onerror = errorEvent => {
                    console.error('Frontend WebSocket Error:', errorEvent);
                    appendOutput("--- WebSocket Error: Could not connect or connection lost. Check browser console (F12). ---", 'error');
                    runBtn.disabled = false;
                    enableInput(false);
                };

                ws.onclose = event => {
                    console.log('Frontend WebSocket connection closed. Code:', event.code, 'Reason:', event.reason);
                    appendOutput("--- Backend connection closed ---", 'status');
                    if (runBtn.disabled) {
                        runBtn.disabled = false;
                        enableInput(false);
                    }
                };
            });

            function sendInput() {
                const input = terminalInput.value;
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ type: 'input', value: input }));
                    appendOutput(`> ${input}`, 'input');
                    terminalInput.value = '';
                } else {
                    appendOutput("Cannot send input: WebSocket is not connected.", "error");
                }
            }

            // Ensure these buttons exist before adding listeners
            if (sendInputBtn && terminalInput) {
                sendInputBtn.addEventListener('click', sendInput);
                terminalInput.addEventListener('keypress', (event) => {
                    if (event.key === 'Enter' && !terminalInput.disabled) {
                        sendInput();
                    }
                });
            } else {
                console.error("Error: Send input button or terminal input field not found.");
            }
            
            editor.focus();
        }
    </script>
</body>
</html>