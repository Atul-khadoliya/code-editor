<script src="https://unpkg.com/monaco-editor@0.48.0/min/vs/loader.js"></script>
    <script>
        let editor; // Declare Monaco editor instance globally accessible

        require.config({ paths: { 'vs': 'https://unpkg.com/monaco-editor@0.48.0/min/vs' }});

        require(['vs/editor/editor.main'], function() {
            editor = monaco.editor.create(document.getElementById('editor'), {
                value: `print("Hello, interactive world!")
name = input("What's your name? ")
print(f"Nice to meet you, {name}!")
age = input("How old are you? ")
print(f"So you are {age} years old.")`,
                language: 'python',
                theme: 'vs-dark',
                minimap: { enabled: false },
                automaticLayout: true
            });
            initializeApplication();
        });

        function initializeApplication() {
            const terminalOutput = document.getElementById('terminal-output');
            const terminalInput = document.getElementById('terminal-input');
            const sendInputBtn = document.getElementById('send-input-btn');
            const runBtn = document.getElementById('run-btn');

            let ws = null; // WebSocket variable managed within this scope

            function appendOutput(message, type = 'info') {
                const messageElement = document.createElement('div');
                messageElement.textContent = message;
                if (type === 'error') {
                    messageElement.style.color = 'red';
                } else if (type === 'status') {
                    messageElement.style.color = 'lightgray';
                }
                terminalOutput.appendChild(messageElement);
                terminalOutput.scrollTop = terminalOutput.scrollHeight;
            }

            function clearOutput() {
                terminalOutput.innerHTML = '';
            }

            function enableInput(enable) {
                terminalInput.disabled = !enable;
                sendInputBtn.disabled = !enable;
                if (enable) {
                    terminalInput.focus();
                }
            }

            runBtn.addEventListener('click', () => {
                clearOutput();
                enableInput(false);
                runBtn.disabled = true;
                appendOutput("Processing...", "status");

                // If a WebSocket connection already exists, close it properly.
                if (ws) {
                    console.log("Closing previous WebSocket connection if open.");
                    // Remove old listeners to prevent them from firing for the old socket
                    ws.onopen = null;
                    ws.onmessage = null;
                    ws.onerror = null;
                    ws.onclose = null;
                    if (ws.readyState === WebSocket.OPEN || ws.readyState === WebSocket.CONNECTING) {
                        ws.close();
                    }
                }

                appendOutput("Attempting to connect to backend wss://myonlinepython.in ...", "status");
                // Assign to the 'ws' variable declared in the initializeApplication scope
                // ***** THIS IS THE KEY FIX: changed 'const ws =' to 'ws =' *****
                ws = new WebSocket('wss://myonlinepython.in');

                ws.onopen = () => {
                    console.log('Frontend WebSocket connection opened to wss://myonlinepython.in');
                    appendOutput("Connection established. Sending code...", "status");
                    const code = editor.getValue();
                    if (ws.readyState === WebSocket.OPEN) { // Double check before sending
                        ws.send(JSON.stringify({ type: 'code', value: code, language: 'python' }));
                    }
                };

                ws.onmessage = event => {
                    console.log('Frontend received message:', event.data);
                    try {
                        const data = JSON.parse(event.data);
                        if (data.type === 'output') {
                            appendOutput(data.value, 'output');
                            const trimmedValue = data.value.trim().toLowerCase(); // Make check case-insensitive
                            // More robust check for prompts might be needed based on backend output
                            if (trimmedValue.includes('?') || trimmedValue.endsWith(':') || trimmedValue === '') {
                                if (runBtn.disabled) {
                                    enableInput(true);
                                }
                            }
                        } else if (data.type === 'error') {
                            appendOutput(`ERROR: ${data.value}`, 'error');
                            if (ws && ws.readyState === WebSocket.OPEN) ws.close(); // Close on error
                            runBtn.disabled = false;
                            enableInput(false);
                        } else if (data.type === 'status') {
                            appendOutput(`STATUS: ${data.value}`, 'status');
                        } else if (data.type === 'end') {
                            appendOutput("--- Program Finished ---", 'status');
                            if (ws && ws.readyState === WebSocket.OPEN) ws.close(); // Close on end
                            runBtn.disabled = false;
                            enableInput(false);
                        }
                    } catch (e) {
                        console.error("Error parsing message from backend or handling it:", e);
                        appendOutput("Received unparseable message from backend: " + event.data, "error");
                    }
                };

                ws.onerror = errorEvent => { // errorEvent is the correct parameter name
                    console.error('Frontend WebSocket Error:', errorEvent);
                    appendOutput("--- WebSocket Error: Could not connect or connection lost. Check browser console (F12). ---", 'error');
                    runBtn.disabled = false;
                    enableInput(false);
                };

                ws.onclose = event => {
                    console.log('Frontend WebSocket connection closed. Code:', event.code, 'Reason:', event.reason);
                    appendOutput("--- Backend connection closed ---", 'status');
                    if (runBtn.disabled) { // Only re-enable if not already done by 'end' or 'error'
                        runBtn.disabled = false;
                        enableInput(false);
                    }
                };
            });

            function sendInput() {
                const input = terminalInput.value;
                if (ws && ws.readyState === WebSocket.OPEN) { // Check the 'ws' from initializeApplication scope
                    ws.send(JSON.stringify({ type: 'input', value: input }));
                    appendOutput(`> ${input}`, 'input');
                    terminalInput.value = '';
                } else {
                    appendOutput("Cannot send input: WebSocket is not connected.", "error");
                }
            }

            sendInputBtn.addEventListener('click', sendInput);
            terminalInput.addEventListener('keypress', (event) => {
                if (event.key === 'Enter' && !terminalInput.disabled) {
                    sendInput();
                }
            });

            if (editor) {
                editor.focus();
            }
        }
    </script>
</body>
</html>